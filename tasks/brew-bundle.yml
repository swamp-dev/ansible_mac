- name: Check if Brewfile exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/Brewfile"
  register: brewfile_exists
  tags:
    - brew
    - mac-setup

- name: Install packages from Brewfile
  ansible.builtin.shell: |
    brew bundle install --file={{ playbook_dir }}/Brewfile
  args:
    chdir: "{{ playbook_dir }}"
    executable: /bin/zsh
    pty: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup
  register: brew_bundle_result
  changed_when: 
    - brew_bundle_result.rc == 0
    - ("Installing" in brew_bundle_result.stdout or 
       "Upgrading" in brew_bundle_result.stdout or
       "Using" in brew_bundle_result.stdout)
  failed_when: brew_bundle_result.rc != 0

- name: Start skhd service
  ansible.builtin.command: skhd --start-service
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup
  ignore_errors: true

- name: Start sketchybar service
  ansible.builtin.command: brew services start sketchybar
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup
  ignore_errors: true

- name: Start yabai service
  ansible.builtin.command: yabai --start-service
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup
  ignore_errors: true

# Post-installation configuration tasks

- name: Check if openjdk@11 is installed
  ansible.builtin.stat:
    path: /opt/homebrew/opt/openjdk@11
  register: java11_installed
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup

- name: Create Java symlink for openjdk@11
  become: true
  ansible.builtin.file:
    src: /opt/homebrew/opt/openjdk@11/libexec/openjdk.jdk
    dest: /Library/Java/JavaVirtualMachines/openjdk-11.jdk
    state: link
    force: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - java11_installed.stat.exists
  tags:
    - brew
    - mac-setup

- name: Check if Java PATH is already in zshrc
  ansible.builtin.shell: grep -q 'openjdk@11/bin' {{ home }}/.zshrc || echo "not found"
  register: java_path_check
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - java11_installed.stat.exists
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Add Java PATH to zshrc
  ansible.builtin.lineinfile:
    path: "{{ home }}/.zshrc"
    line: 'export PATH="/opt/homebrew/opt/openjdk@11/bin:$PATH"'
    create: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - java11_installed.stat.exists
    - "'not found' in java_path_check.stdout"
  tags:
    - brew
    - mac-setup

- name: Check if Java CPPFLAGS is already in zshrc
  ansible.builtin.shell: grep -q 'openjdk@11/include' {{ home }}/.zshrc || echo "not found"
  register: java_cppflags_check
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - java11_installed.stat.exists
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Add Java CPPFLAGS to zshrc
  ansible.builtin.lineinfile:
    path: "{{ home }}/.zshrc"
    line: 'export CPPFLAGS="-I/opt/homebrew/opt/openjdk@11/include"'
    create: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - java11_installed.stat.exists
    - "'not found' in java_cppflags_check.stdout"
  tags:
    - brew
    - mac-setup

- name: Check if pyenv is installed
  ansible.builtin.stat:
    path: "{{ home }}/.pyenv"
  register: pyenv_installed
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup

- name: Check if pyenv root is already in zshrc
  ansible.builtin.shell: grep -q 'PYENV_ROOT' {{ home }}/.zshrc || echo "not found"
  register: pyenv_root_check
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - pyenv_installed.stat.exists
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Add pyenv root to zshrc
  ansible.builtin.lineinfile:
    path: "{{ home }}/.zshrc"
    line: 'export PYENV_ROOT="$HOME/.pyenv"'
    create: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - pyenv_installed.stat.exists
    - "'not found' in pyenv_root_check.stdout"
  tags:
    - brew
    - mac-setup

- name: Check if pyenv path is already in zshrc
  ansible.builtin.shell: grep -q 'PYENV_ROOT/bin' {{ home }}/.zshrc || echo "not found"
  register: pyenv_path_check
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - pyenv_installed.stat.exists
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Add pyenv path to zshrc
  ansible.builtin.lineinfile:
    path: "{{ home }}/.zshrc"
    line: 'export PATH="$PYENV_ROOT/bin:$PATH"'
    create: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - pyenv_installed.stat.exists
    - "'not found' in pyenv_path_check.stdout"
  tags:
    - brew
    - mac-setup

- name: Check if pyenv init is already in zshrc
  ansible.builtin.shell: grep -q 'pyenv init' {{ home }}/.zshrc || echo "not found"
  register: pyenv_init_check
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - pyenv_installed.stat.exists
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Add pyenv init to zshrc
  ansible.builtin.blockinfile:
    path: "{{ home }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - pyenv init"
    block: |
      if command -v pyenv 1>/dev/null 2>&1; then
        eval "$(pyenv init --path)"
        eval "$(pyenv init -)"
      fi
    create: yes
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - pyenv_installed.stat.exists
    - "'not found' in pyenv_init_check.stdout"
  tags:
    - brew
    - mac-setup

- name: Get yabai binary path
  ansible.builtin.command: which yabai
  register: yabai_path
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Get yabai SHA256 hash
  ansible.builtin.shell: shasum -a 256 {{ yabai_path.stdout }} | awk '{print $1}'
  register: yabai_hash
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - yabai_path.rc == 0
  tags:
    - brew
    - mac-setup
  changed_when: false
  failed_when: false

- name: Check if yabai sudoers file exists
  ansible.builtin.stat:
    path: /private/etc/sudoers.d/yabai
  register: yabai_sudoers_exists
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - yabai_path.rc == 0
    - yabai_hash.rc == 0
  tags:
    - brew
    - mac-setup

- name: Create yabai sudoers configuration
  become: true
  ansible.builtin.copy:
    dest: /private/etc/sudoers.d/yabai
    content: "{{ user }} ALL=(root) NOPASSWD: sha256:{{ yabai_hash.stdout | trim }} {{ yabai_path.stdout }} --load-sa\n"
    mode: '0440'
    validate: 'visudo -cf %s'
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - yabai_path.rc == 0
    - yabai_hash.rc == 0
    - not yabai_sudoers_exists.stat.exists
  tags:
    - brew
    - mac-setup

- name: Check if docker is installed
  ansible.builtin.stat:
    path: /Applications/Docker.app
  register: docker_installed
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
  tags:
    - brew
    - mac-setup
    - docker

- name: Check if user is in docker group
  ansible.builtin.shell: groups {{ user }} | grep -q docker && echo "yes" || echo "no"
  register: user_in_docker_group
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - docker_installed.stat.exists
  tags:
    - brew
    - mac-setup
    - docker
  changed_when: false
  failed_when: false

- name: Add user to docker group
  become: true
  ansible.builtin.user:
    name: "{{ user }}"
    append: yes
    groups: docker
  when:
    - ansible_distribution == 'MacOSX'
    - brewfile_exists.stat.exists
    - docker_installed.stat.exists
    - "'no' in user_in_docker_group.stdout"
  tags:
    - brew
    - mac-setup
    - docker
